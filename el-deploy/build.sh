#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ —Å—Ö–µ–º—ã —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–∫–∏
# –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –º–æ–¥—É–ª–∏ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PNG

set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üîå –°–±–æ—Ä–∫–∞ —Å—Ö–µ–º—ã —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–∫–∏..."

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p tmp/electro-build

# –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª
cp main.d2 tmp/all.d2

# –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
echo "" >> tmp/all.d2
echo "# === –ò–ú–ü–û–†–¢–ò–†–û–í–ê–ù–ù–´–ï –ú–û–î–£–õ–ò ===" >> tmp/all.d2

for module in modules/*.d2; do
    if [ -f "$module" ]; then
        echo "" >> tmp/all.d2
        echo "# –ú–æ–¥—É–ª—å: $(basename $module)" >> tmp/all.d2
        cat "$module" >> tmp/all.d2
        echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å: $module"
    fi
done

echo "" >> tmp/all.d2
echo "# === –ö–û–ù–ï–¶ –°–ë–û–†–ö–ò ===" >> tmp/all.d2

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PNG —Å ELK layout
echo "üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PNG —Å ELK layout..."
d2 --layout=elk --theme=300 tmp/all.d2 tmp/all.png

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
if [ $? -eq 0 ]; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo "üìÅ –§–∞–π–ª—ã:"
    echo "   - –°—Ö–µ–º–∞ D2: tmp/all.d2"
    echo "   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: tmp/all.png"
    echo ""
    echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
    echo "   –†–∞–∑–º–µ—Ä D2 —Ñ–∞–π–ª–∞: $(wc -l < tmp/all.d2) —Å—Ç—Ä–æ–∫"
    echo "   –ú–æ–¥—É–ª–µ–π —Å–æ–±—Ä–∞–Ω–æ: $(ls modules/*.d2 | wc -l)"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã"
    exit 1
fi